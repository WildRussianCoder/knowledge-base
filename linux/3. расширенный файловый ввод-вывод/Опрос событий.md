# Опрос событий 

## Создание нового экземпляра epoll

Контекст опроса событий создается с помощью вызова `epoll_create1()`:

    #include <sys/epoll.h>

    int epoll_create1(int flags);

    int epoll_create(int size); // устарело

При успешном вызове создается новый экземпляр `epoll` и возвращается файловый дескриптор, ассоциированный с данными экземпляром.

Параметр `flags` позволяет модифицировать поведение опроса событий. В настоящее время допустимым считается только один флаг - `EPOLL_CLOEXEC`. Он обеспечивает автоматическое закрытие дескриптора во время вызова.

При ошибке - `-1` и `errno`.

## Управление epoll

Системный вызов `epoll_ctl()` можно использовать для добавления файловых дескрипторов в заданный контекст опрос и удаления этих дескрипторов из контекста:

    #include <sys/epoll.h>

    int epoll_ctl(int epfd, int op, int fd, struct epoll_event* event);

Заголовок `<sys/epoll.h>` определяет структуру `epoll_event` так:

    struct epoll_event{
        __u32 events; // события
        union{
            void* ptr;
            int fd;
            __u32 u32;
            __u64 u64;
        } data;
    };

Успешный вызов управляет экземпляром `epoll`, ассоциированным с файловым дескриптором `epfd`. Параметр `op` указывает операцию, которую нужно применить к файлу, ассоциированному с `fd`. Параметр `event` подробнее описывает ход операции.

Вот допустимые значения, которые может принимать параметр `op`:
* `EPOLL_CTL_ADD` - добавляет монитор для файла, ассоциированного с `fd`, к экземпляру `epfd`, при этом наблюдает за событиями, определенными в `event`
* `EPOLL_CTL_DEL` - удаляет монитор для файла
* `EPOLL_CTL_MOD` - изменяет существующий монитор, задавая для него обновленные события, указанные в `event`.

В поле `events` структуры `epoll_event` перечисляется, какие события нужно отслеживать на заданном файловом дескрипторе. Множественные события могут быть перечисленны с помощью побитового "ИЛИ". Ниже приведены допустимые значения:
* `EPOLLERR` - в файле возникло условие ошибки. Это собитие отслеживается всегда, даже без явного указания
* `EPOLLET` - обеспечивет запуск по фронту сигнала для монитора файла. По умолчанию используется запуск по уровню сигнала.
* `EPOLLHUP` - произошло зависание файла. Всегда отслеживается
* `EPOLLIN` - файл доступен для считывания без блокирования
* `EPOLLONESHOT` - после того как событие сгенерировано и прочтено, наблюдение за файлом автоматически прекращается. Для возобновления наблюдения следует указать новую маску события с помощью `EPOLL_CTL_MOD`
* `EPOLLOUT` - файл доступен для записи без блокирования
* `EPOLLPRI` - имеются внеполосные данные для срочного считывания

Поле `data` в структуре `epoll_event` предназначено для частичного применения пользователями. Содержимое возвращается пользователю после получения запрошенного события. Как правило, `event.data.fd` устанавливается в значение `fd`, благодаря чему становится просто найти файловый дескриптор, вызвавший событие.

В случае успеха `epoll_ctl()` возвращает `0`. При ошибке вывоз возвращает `-1` и устанавливает `errno`.

## Ожидание событий с помощью epoll

Системный вызов `epoll_wait()` ожидает событий на файловых дескрипторах, ассоциированных с заданным экземпляром опроса событий:

    #include <sys/epoll.h>

    int epoll_wait(int epfd, struct epoll_event* events, int maxevents, int timeout);

Вызов `epoll_wait()` ожидает в течение не более `timeout` миллисекунд. Он отслеживает события, которые могут происходить в файлах, ассоциированных с экземпляром опроса событий `epfd`. В случае успеха `events` будет указывать на область памяти, содержащую структуры epoll_event, описывающие каждое событие - не более `maxevents` событий. Возвращаемое значение соответствует количеству найденных событий или `-1` в случае ошибки. 

Если значение `timeout` равно нулю, то вызов возвращается немедленно, даже если доступные события отсутствуют - в таком случае возвращаемое значение этого вызова будет равно нулю. Если значение `timeout` равно `-1`, то вызов не вернется, пока не появится доступное событие.

После возврата вызова поле `events` структуры `epoll_event` будет описывать произошедшие события. Поле `data` содержит значение, которое в него установил пользователь до вызова `epoll_ctl()`.
