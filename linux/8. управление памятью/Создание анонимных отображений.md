# Создание анонимных отображений в памяти

    #include <sys/mman.h>

    void* mmap(void* start,
            size_t length,
            int prot,
            int flags,
            int fd,
            off_t offset);

    int munmap(void* start, size_t length);

Создать анонимное отображение в памяти проще, чем отображение, в основе которого лежит файл, поскольку в первом случае не приходится ни открывать файл, ни управлять им. Основное отличие заключается в присутствии специального флага, указывающего, что отображение является анонимным. Рассмотрим пример:

    void* p;

    p = mmap(NULL, // наважно где
            512 * 1024, // 512 кб
            PROT_READ | PROT_WRITE, // чтение и запись
            MAP_ANONYMOUS | MAP_PRIVATE, // анонимное и приватное
            -1, // fd (игнорируется)
            0); // смещение(игнорируется)

    if(p == MAP_FAILED)
        perror("mmap");
    else
        // p указывает на 512 кб анонимной памяти...

При большинстве анонимных отображений параметры `mmap()` соответствуют этому примеру, за исключением, разумеется, передачи произвольного размера (в байтах), определяемого программистом. Другие параметры обычно таковы:

* Первый параметр, `start`, устанавливается в значение `NULL`, указывая, что анонимное отображение может начинаться в любой точке памяти, выбранной ядром.
* Параметр `prot` обычно одновременно задает биты `PROT_READ` и `PROT_WRITE`, допуская как считывание отображения, так и запись в него. С другой стороны, выполнение кода из анонимного отображения обычно нежелательно, так как это возможный вектор для атаки злоумышленников.
* Параметр `flags` задает флаг `MAP_ANONYMOUS`, делая данное отображение анонимным, а также флаг `MAP_PRIVATE`, делая отображение приватным
* Параметры `fd` и `offset` игнорируются, если задан флаг `MAP_ANONYMOUS`. Однако а некоторых старых системах предполагается, что в данном случае `fd` должен иметь значение `-1`, поэтому такое значение целесообразно задавать для обеспечения переносимости.

Системный вызов `munmap()` высовобождает анонимное отображение, возвращая выделенную память ядру.