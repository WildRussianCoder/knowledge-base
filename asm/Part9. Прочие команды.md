# Прочие команды

## Команды CLI и STI

**Команды CLI (Clear Interrupt) и STI (Set Interrupt) сбрасывают и устанавливают флаг прерывания IF**

    CLI ; IF = 0
    STI ; IF = 1
    
## Команды STD и CLD

Команды STD и CLD модифицируют значение флага DF. Этим флагом пользуется группа команд для обработки строк. Команда CLD сбрасывает флаг (что означает отсчет вверх), а STD устанавливает флаг (отстчет в обратном порядке).
    
    CLD ; FD = 0
    STD ; FD = 1
    
## Команда XCHG - обмен местами операндов

    XCHG o1, o2 ; o1 <=> o2
    
## Команда LEA - не только вычисление адреса

Имя этой команды - это сокращение от "Load Effective Address", то есть "загрузить эффективный адрес". Она вычисляет эффективный адрес второго операнда и сохраняет его в первом операнде (который может быть только регистром). Синтаксис этой команды требует, чтобы второй операнд был заключен в квадратные скобки, но фактически она не адресует память.

    LEA o1, [o2]
    
LEA полезна в тех случаях, когда мы не собираемся обращаться к памяти, а адрес нужен нам для другой цели:
    
    lea ldi, [ebx*4 + e] ; загружает в регистр EDI адрес,
                         ; вычесленный как EDI = EBX*4+ECX
                         
Значение, вычисленное этой командой, не обязательно рассматривать как адрес: ее можно использовать для целочисленных арифметических вычислений. 

## Команды STOSx - запись строки в память

Под единым обозначением STOSx (STOre String) скрываются три команды: 
* STOSB
* STOSW
* STOSD

Команда STOSB копирует содержимое регистро AL в ячейку памяти, адрес которой находится в паре регистров ES:(E)DI, и уменьшает или увеличивает (в зависимости от флага DF) на единицу значение регистра (E)DI, чтобы приготовиться к копированию AL в следующую ячейку. Если DF = 0, то (E)DI будет увеличен на 1, в противном случае - уменьшен на 1. Какой регистр будет использоваться - DI или EDI - зависит от режима процессора. 

Вторая команда работает аналогично, но данные берутся из регистра AX, а (E)DI уменьшается/увеличивается на 2. STOSD копирует содержимое EAX, а (E)DI уменьшается/увеличивается на 4.

## Команды LODSx - чтение строки из памяти

Под единым обозначением LODSx (LOaD String) скрываются три команды:
* LODSB
* LODSW
* LODSD

Действие этих команд противоположно командам STOSx: они копируют порцию данных из памяти в регистр AL, AX и EAX. Адрес нужной ячейки памяти берется из пары DS:(E)SI. Если флаг DF равен нулю, то регистр (E)SI будет увеличен на 1/2/4 (B, W, D), в противном случае - уменьшен на 1/2/4.

## Команды CMPSx - сравнение строк

Под единым обозначением CMPSx (CoMPare String) скрываются три команды:
* CMPSB
* CMPSW
* CMPSD

Команда CMPSB сравнивает байт, находящийся по адресу ES:(E)DI, с байтом по адресу DS:(E)SI и изменяет значения регистров SI и DI в зависимости от флага DF. Команды CMPSW и CMPSD сравнивают не байты, а слова и двойные слова соответственно, увеличивая или уменьшая регистры SI и DI на размер порции данных (2 или 4).

## Команды SCASx - поиск символа в строке

Под единым обозначением SCASx (SCAn String) скрываются три команды:
* SCASB
* SCASW
* SCASD

Команды SCASB/W/D сравнивают значение регистра AL/AX/EAX со значением по адресу [ES:(E)DI]. Регистр (E)DI изменяется в зависимости от флага DF.

## Команды REP и REPZ - повторение следующей команды

Команда REP (Repeat) облегчает обработку строк произвольной длины. Это так называемая префиксная команды: ее нельзя использовать отдельно, а только в паре с какой-нибудь другой командой. Она работает подобно команде LOOP: повторяет следующую за ней команду до тех пор, пока значение в регистре (E)CX не станет равно нулю. Регистр (E)CX уменьшается на единицу при каждой итерации. Чаще всего команда REP применяется в паре с MOVS или STOS.

Команда REPZ (синоним REPE), подобно команде LOOPZ, позволяет уточнить условие. Следующая итерация выполняется тогда, когда не только (E)CX не равен нулю, но и флаг ZF установлен. Второе условие может быть инвертированно командой REPNZ (синоним REPNE). Эта команда часто используется вместе со SCAS или CMPS.

## Команды IN и OUT - обмен данными с периферией

Команда IN позволяет получить от устройства, а OUT - передать устройству порцию данных в размере байта слова или двойного слова.

Команда IN читает данные из порта ввода/вывода, номер которого содержится в регистре DX и помещает результат в регистр AL/AX/EAX. Другие регистры, кроме AL/AX/EAX и DX, использовать нельзя.

Команда OUT отправляет данные в порт. Типы ее операндов такие же, как у IN, но операнды указываются в обратном порядке.

**Диапазоны портов ввода/вывода**

| НОМЕРА                 | ОПИСАНИЕ                               |
|:-------------------    |:--------------------------------       |
| 0000-001F: dma1        | Первый контроллер                      |
| 0020-003F: pic1        | Первый аппаратный контроллер прерываний|
| 0040-005F: timer       | Системный таймер                       |
| 0060-006F: keyboard    | Клавиатура                             |
| 0070-007F: rtc         | Real Time Clock                        |
| 0080-008F: dma page reg| DMA page register                      |
| 00A0-00BF: pic2        | Второй аппаратный контроллер прерываний|
| 00C0-00DF: dma2        | Второй DMA-контроллер                  |
| 00F0-00FF: fpu         | Мат. сопроцессор                       |
| 0170-0177: ide1        | Второй IDE-контроллер                  |
| 01F0-01F7: ide0        | Первый IDE-контроллер                  |
| 0213-0213: isapnp read | Интерфейс PnP шины ISA                 |
| 0220-022F: soundblaster| Звуковая плата                         |
| 0290-0297: w83781d     | Аппар. мониторинг температуры и напряж.|
| 0376-0376: ide1        | Второй IDE-контроллер (продолжение)    |
| 03C0-03DF: vga+        | Видеоадаптер                           |
| 03F2-03F5: floopy      | Дисковод гибких дисков                 |
| 03F6-03F6: ide0        | Первый IDE-контроллер (продолжение)    |
| 03F7-03F7: floopy DIR  | Дисковод для гибких дисков (прод.)     |
| 03F8-03FF: lirc_serial | Последовательный порт                  |
| 0A79-0A79: isapnp write| Интерфейс PnP шины ISA (продолжение)   |
| 0CF8-0CFF: PCI conf1   | Первый конф. регистр шины PCI          |
| 4000-403F              | Чипсет ACPI                            |
| 5000-501F              | Чипсет ACPI                            |
| E000-E01F              | Чипсет USB                             |
| F000-F00F              | Чипсет контроллера дисков              |

## Команда NOP - организация задержки

    NOP ; ничего не делать
    
Лучшим способом подождать периферийное устройство будет запись произвольного значения в безопасный порт - это диагностический порт с номером 0x80:

    out 0x80, al ; это просто задержка
    
## Команды SHR и SHL - сдвиг беззнаковых чисел

**Команды SHR и SHL поразрядно сдвигают беззнаковые числа вправо и влево соответственно.**

    SHL o1, o2
    SHR o1, o2
    
Первый операнд должен быть регистром или адресом памяти, который нужно сдвинуть. Второй операнд определяет число позиций, на которое нужно сдвинуть. Чаще всего это непосредственное значение. Можно использовать в качестве второго операнда и регистр, но только CL - это касается всех операций сдвига и ротации. Сдвиг возможен не более чем на 32 позиции, поэтому принимается в расчет не весь второй операнд, а остаток от его деления на 32. 

Вытолкнутый бит сохраняется во флаге CF, а младший бит заменяется нулем. Кроме флага CF используется флаг знака (SF) и флаг переполнения (OF). За этоими флагами нужно следить, выполняя действия над числами со знаком, чтобы избежать превращения положительного числа в отрицательное и наоборот. 

## Команды SAL и SAR - сдвиг чисел со знаком

**Команды SAL и SAR используются для поразрядного сдвига целых чисел со знаком (арифметического сдвига). Команда SAL - это сдвиг влево, а команда SAR - вправо.**

    SAL o1, o2
    SAR o1, o2
    
Команда SAR сдвигает все биты, кроме старшего, означающего знак числа - этот бит сохраняется. Младший бик, как обычно, вытесняется в CF. Операнды обеих инструкций такие же, как у SHL и SHR.

## Команды RCR и RCL - ротация через флаг переноса

    RCR o1, o2
    RCL o1, o2
    
## Команды ROR и ROL - ротация с выносом во флаг переноса

    ROR o1, o2
    ROL o1, o2
    
