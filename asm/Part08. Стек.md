# Команды обработки стека

## Команды PUSH и POP: втолкнуть и вытолкнуть

**Команда PUSH позволяет поместить в стек содержимое любого 16- или 32-битного регистра или ячейки памяти.** 

    PUSH eax
    
**Команда POP записывает в свой операнд значение вершины стека.**

    POP eax
    
## Команды PUSHA/POPA и PUSHAD/POPAD: толкаем все регистры общего назначения

    PUSHA  ; 16-разрядные РОН
    POPA
    
    PUSHAD ; 32-разрядные РОН
    POPAD
    
После команд стек выглядит так: (возможно наоборот)

| СТЕК |
|:----:|
| AX   |
| CX   |
| DX   |
| BX   |
| SP   |
| BP   |
| SI   |
| DI   |

## Команды PUSHF/POPF и PUSHFD/POPFD: толкаем флаги

    PUSHF
    POPF
    
    PUSHFD
    POPFD
    
## Команды CALL и RET: организуем подпрограмму

**Для вызова подпрограмм используется команда CALL, а для возврата из подпрограммы в основную программу - RET**

    CALL тип_вызова операнды
    RET
    
Если была вызвана дальняя подпрограмма: CALL FAR, то возврат из нее нужно осуществлять не командой RET, а командой RETF.

## Команды INT и IRET: вызываем прерывание

**Программные прерывания порождаются по команде INT** 

    INT op
    
Аппаратные прерывания вызываются аппаратными средствами компьютера, подключенными к общей шине. Устройство, запрашивающее прерывание, генерирует так называемый запрос на прерывание. Всего существует 16 аппаратных запросов на прерывание, поскольку только 16 проводников в шине ISA выделено для этой цели. Запрос на прерывание направляется контроллеру прерываний, который, в свою очередь, запрашивает микропроцессор. Вместе с запросом он передает процессору номер прерывания. После запуска компьютера и загрузки операционной системы DOS, IRQ 0 (системный таймер) соответствует прерыванию 8 (часы). 

Когда процессор получает номер прерывания, он помещает в стек контекст выполняемой в данный момент программы, подобно тому, как человек кладет в книгу закладку, чтобы не забыть, с какого места продолжить чтение книги. Роль закладки играют значения CS, (E)IP и регистры флагов.

Теперь процессор будет выполнять другую программу - обработчик прерывания. Адрес этой программы называется вектором прерывания. Векторы прерывания хранятся в таблице векторов прерываний, находящейся в памяти. Таблицу прерываний можно представить себе как массив адресов подпрограмм, в котором индекс массива соответствует номеру прерывания.

После того, как процессор определит адрес обработчика прерывания, он запишет его в пару CS и (E)IP. Следующая выполненная команда будет первой командой обработчика прерывания.

**Возврат из обработчика прерывания осуществляется с помощью команды IRET, которая восстанавливает исходные значения (E)IP, CS и флагов из стека**

    IRET
    
Таблица векторов прерываний находится в самом начале адресуемой памяти, то есть по адресу 0x0000:0x0000. Каждый из векторов прерывания занимает четыре байта. Первые два байта определяют новое значение IP (то есть смещение), а оставшиеся два - новое значение CS. 

Программные прерывания часто используются как шлюз для вызова функций операционной системы.